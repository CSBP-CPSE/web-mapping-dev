<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title></title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.2.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.2.0/mapbox-gl.css' rel='stylesheet' />
    <style>
      body {
        margin: 0;
        padding: 0;
      }

      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }
	  
	  .mapboxgl-canvas {
		cursor : pointer;
	  }
    </style>
</head>
<body>
<div id='map'></div>
<script>

function GetUrlParameter(name) {				
	name = name.replace(/[\[\]]/g, '\\$&');
	
	var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
	
	results = regex.exec(window.location.href);
	
	if (!results) return null;
	
	if (!results[2]) return '';
	
	return decodeURIComponent(results[2].replace(/\+/g, ' '));
}

function Request(url, success, failure) {
	var xhttp = new XMLHttpRequest();
	
	xhttp.onreadystatechange = function() {
		if (this.readyState != 4) return;
	
		// TODO : Switched to this.response, check if it breaks anything
		if (this.status == 200) success(this.response);
		
		else failure({ status:this.status, response:this.response });
	};
	
	xhttp.open("GET", url, true);
	
	xhttp.send();
}

function HTMLize(json) {
	var html = "<div class='popup-inner'>";

	for (var key in json) {
		if (key == "tilequery") continue;
	
		html += "<div class='row'>";
		html += "<span>" + key + " : </span>";
		html += "<span>" + json[key] + "</span>";
		html += "</div>";
	}
	
	html += "</div>";
	
	return html;
}

var ctx = GetUrlParameter("map");

if (ctx == null) ctx = "odb";

var style, center, zoom, tileset, layers, paint, classes;

if (ctx == "odb") {
	style = 'mapbox://styles/staubibr/cjz1cmtys0yee1cpdmnftk2f0';
	center = [-75.6972, 45.4215];
	zoom = 11;
	tileset = 'staubibr.80y3tqc4';
	layers = ['odb-ontario-4326'];
	paint = 'odb-ontario-4326';

	classes = [
	  'case',
	  ['<', ['get', 'Shape_Area'], 1000], '#639AFE',
	  ['<', ['get', 'Shape_Area'], 3000], '#967CE3',
	  ['<', ['get', 'Shape_Area'], 5000], '#B759BB',
	  ['<', ['get', 'Shape_Area'], 10000], '#C63388',
	  ['<', ['get', 'Shape_Area'], 20000], '#C20652',
	  '#AD001B'
	];
}
else if (ctx == "campus") {
	style = 'mapbox://styles/staubibr/cjz1pb1g76swj1coy6ec94cx7';
	center = [-75.69596, 45.3858];
	zoom = 15;
	tileset = 'staubibr.2ipbn29t';
	layers = ['tunnels', 'rails', 'roads', 'parking-lot-lines', 'trees', 'shrubs', 'buildings'];
	paint = 'buildings';

	classes = [
	  'case',
	  ['==', ['get', 'status'], 'OnGoing'], '#E0005F',
	  ['<', ['get', 'Shape_Area'], 500], '#00C2D6',
	  ['<', ['get', 'Shape_Area'], 1000], '#009BE5',
	  ['<', ['get', 'Shape_Area'], 3000], '#0073E1',
	  ['<', ['get', 'Shape_Area'], 5000], '#0047C4',
	  '#05028D'
	];
}

mapboxgl.accessToken = 'pk.eyJ1Ijoic3RhdWJpYnIiLCJhIjoiY2p5aHJuZHRnMDJwdzNucDBkc3NoNmR2OCJ9.Dq-q5yKwOpULPIRJMhqnow';

var map = new mapboxgl.Map({ container: 'map', style: style, center: center, zoom: zoom });
	
var nav = new mapboxgl.NavigationControl();

map.addControl(nav, 'top-left');
	
map.addControl(new mapboxgl.GeolocateControl({
	positionOptions: { enableHighAccuracy: true },
	trackUserLocation: true
}));

// map.addControl(new mapboxgl.AttributionControl({ compact: true }));

var scale = new mapboxgl.ScaleControl({
	maxWidth: 80,
	unit: 'imperial'
});

map.addControl(scale);

scale.setUnit('metric');

map.on('load', function(ev) { 
	for (var i = 0; i < layers.length; i++) map.moveLayer(layers[i]);
	
	map.setPaintProperty(paint, 'fill-color', classes);
/*
	map.on('click', function(ev) {
		var lat = ev.lngLat.lat;
		var lng = ev.lngLat.lng;
		var url = "https://api.mapbox.com/v4/" + tileset + "/tilequery/" + lng + "," + lat + ".json?radius=10&access_token=" + mapboxgl.accessToken + "&layers=" + layers.join(",").replace(/-/g, "_");
		
		Request(url, function(ev) {
			var coll = JSON.parse(ev);
			
			if (coll.features.length == 0) return;
			
			var json = coll.features[0].properties;
			
			var popup = new mapboxgl.Popup({closeOnClick: true})
				.setLngLat([lng, lat])
				.setHTML(HTMLize(json))
				.addTo(map);
		}, function(ev) {
			alert(JSON.stringify(ev));
		});
	});
*/

for (var i = 0; i <Â layers.length; i++) {
	map.on('click', layers[i], function(ev) { 	
		if (ev.features.length == 0) return;
		
		var html = HTMLize(ev.features[0].properties);
		
		var popup = new mapboxgl.Popup({closeOnClick: true})
			.setLngLat(ev.lngLat)
			.setHTML(html)
			.addTo(map);
	})
}


});

</script>
</body>
</html>